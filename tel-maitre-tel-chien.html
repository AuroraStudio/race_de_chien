<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WFNTS7FRZP"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag("js",new Date());gtag("config","G-WFNTS7FRZP");</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta name="description" content="Prenez un selfie et d√©couvrez √† quelle race de chien vous ressemblez ! Un test amusant bas√© sur l'IA parmi 169 races.">
    <title>Tel Ma√Ætre, Tel Chien ‚Äî √Ä quelle race ressemblez-vous ? | Race de Chien</title>
    <link rel="canonical" href="https://race-de-chien.com/tel-maitre-tel-chien.html">
    <meta name="robots" content="index, follow">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Tel Ma√Ætre, Tel Chien ‚Äî √Ä quelle race de chien ressemblez-vous ?">
    <meta property="og:description" content="Prenez un selfie et d√©couvrez √† quelle race de chien vous ressemblez ! Un test amusant bas√© sur l'IA parmi 169 races.">
    <meta property="og:url" content="https://race-de-chien.com/tel-maitre-tel-chien.html">
    <meta property="og:image" content="https://race-de-chien.com/images/breeds/115.jpg">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:site_name" content="Race de Chien">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Tel Ma√Ætre, Tel Chien ‚Äî √Ä quelle race de chien ressemblez-vous ?">
    <meta name="twitter:description" content="Prenez un selfie et d√©couvrez √† quelle race de chien vous ressemblez !">
    <meta name="twitter:image" content="https://race-de-chien.com/images/breeds/115.jpg">

    <!-- Schema.org -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Tel Ma√Ætre, Tel Chien",
        "url": "https://race-de-chien.com/tel-maitre-tel-chien.html",
        "description": "D√©couvrez √† quelle race de chien vous ressemblez gr√¢ce √† l'IA",
        "applicationCategory": "Entertainment",
        "operatingSystem": "Web"
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        secondary: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' },
                        accent: { 50: '#fff7ed', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74', 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12' },
                    }
                }
            }
        }
    </script>
    <style>
        /* ===== ANIMATIONS ===== */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes morph-text {
            0%, 100% { opacity: 1; transform: translateY(0); }
            45% { opacity: 0; transform: translateY(-10px); }
            55% { opacity: 0; transform: translateY(10px); }
        }
        @keyframes progress-fill {
            from { width: 0%; }
        }
        @keyframes bounce-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-wiggle { animation: wiggle 1s ease-in-out infinite; }
        .animate-slide-up { animation: slide-up 0.6s ease-out forwards; }
        .animate-bounce-in { animation: bounce-in 0.5s ease-out forwards; }

        /* ===== CAPTURE ZONE ===== */
        .capture-zone {
            position: relative;
            border: 3px dashed #cbd5e1;
            border-radius: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .capture-zone:hover, .capture-zone.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.03);
        }
        .capture-zone.has-image {
            border-style: solid;
            border-color: #3b82f6;
        }

        /* ===== WEBCAM VIDEO ===== */
        #webcam-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 21px;
            transform: scaleX(-1);
        }

        /* ===== LOADING ===== */
        .loading-dots span {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #3b82f6;
            margin: 0 4px;
            animation: float 1.4s ease-in-out infinite;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* ===== RESULT CARD ===== */
        .result-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .match-badge {
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            color: white;
            font-weight: 800;
            font-size: 1.5rem;
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-block;
        }

        /* ===== COMPARISON ===== */
        .vs-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4);
        }

        /* ===== SHARE BUTTON STYLES ===== */
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-decoration: none;
            color: white;
        }
        .share-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .share-btn-x { background: #000; }
        .share-btn-fb { background: #1877f2; }
        .share-btn-wa { background: #25d366; }
        .share-btn-download { background: linear-gradient(135deg, #3b82f6, #9333ea); }

        /* ===== TRAIT BADGE ===== */
        .trait-badge {
            background: linear-gradient(135deg, #eff6ff, #fdf4ff);
            border: 1px solid #e0e7ff;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4338ca;
        }

        /* ===== CONFETTI ===== */
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 999;
            animation: confetti-fall 3s linear forwards;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <!-- Header -->
    <div class="site-header"></div>

    <!-- Main Content -->
    <main class="pt-24 pb-20">
        <div class="max-w-3xl mx-auto px-4 sm:px-6">

            <!-- ===== HERO SECTION ===== -->
            <section id="hero-section" class="text-center mb-10">
                <div class="text-6xl mb-4 animate-float">üêï</div>
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-slate-900 mb-4 leading-tight">
                    Tel Ma√Ætre, <span class="bg-gradient-to-r from-primary-500 to-secondary-500 bg-clip-text text-transparent">Tel Chien</span>
                </h1>
                <p class="text-lg text-slate-500 max-w-xl mx-auto mb-2">
                    Prenez un selfie et d√©couvrez √† quelle race de chien vous ressemblez parmi nos <strong class="text-slate-700">169 races</strong> !
                </p>
                <p class="text-sm text-slate-400 flex items-center justify-center gap-2">
                    <i class="fas fa-shield-halved text-green-500"></i>
                    Votre photo n'est ni stock√©e ni conserv√©e ‚Äî analyse unique puis suppression.
                </p>
            </section>

            <!-- ===== CAPTURE SECTION ===== -->
            <section id="capture-section">
                <div id="capture-zone" class="capture-zone min-h-[320px] sm:min-h-[400px] flex flex-col items-center justify-center p-8 bg-white cursor-pointer" onclick="handleCaptureClick()">
                    
                    <!-- Default state (no image, no webcam) -->
                    <div id="capture-placeholder" class="text-center">
                        <div class="text-5xl mb-4 animate-wiggle">üì∏</div>
                        <p class="text-slate-700 font-semibold text-lg mb-2">Prenez un selfie ou importez une photo</p>
                        <p class="text-slate-400 text-sm mb-6">Cliquez ici ou utilisez les boutons ci-dessous</p>
                    </div>

                    <!-- Webcam preview -->
                    <video id="webcam-video" class="hidden absolute inset-0" autoplay playsinline muted></video>
                    
                    <!-- Image preview -->
                    <img id="image-preview" class="hidden w-full h-full object-contain absolute inset-0 rounded-[21px] bg-slate-100" alt="Votre photo">
                </div>

                <!-- Action buttons -->
                <div id="action-buttons" class="flex flex-col sm:flex-row items-center justify-center gap-3 mt-5">
                    <button id="btn-webcam" onclick="startWebcam()" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-xl transition-all hover:-translate-y-0.5 shadow-lg shadow-primary-500/25">
                        <i class="fas fa-camera"></i> Prendre un selfie
                    </button>
                    <button id="btn-upload" onclick="document.getElementById('file-input').click()" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-xl transition-all hover:-translate-y-0.5 border border-slate-200 shadow-sm">
                        <i class="fas fa-image"></i> Importer une photo
                    </button>
                    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                </div>

                <!-- Webcam capture button (shown when webcam is active) -->
                <div id="webcam-controls" class="hidden flex items-center justify-center gap-3 mt-5">
                    <button onclick="captureWebcam()" class="inline-flex items-center justify-center gap-2 px-8 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition-all hover:-translate-y-0.5 shadow-lg shadow-red-500/25 text-lg">
                        <i class="fas fa-circle"></i> Capturer
                    </button>
                    <button onclick="stopWebcam()" class="inline-flex items-center justify-center gap-2 px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl transition-all">
                        <i class="fas fa-xmark"></i> Annuler
                    </button>
                </div>

                <!-- Analyze button (shown when image is ready) -->
                <div id="analyze-controls" class="hidden flex flex-col items-center gap-3 mt-5">
                    <button id="btn-analyze" onclick="analyzePhoto()" class="inline-flex items-center justify-center gap-2 px-8 py-4 bg-gradient-to-r from-primary-500 to-secondary-500 hover:from-primary-600 hover:to-secondary-600 text-white font-bold rounded-xl transition-all hover:-translate-y-0.5 shadow-lg shadow-primary-500/25 text-lg">
                        <i class="fas fa-wand-magic-sparkles"></i> D√©couvrir ma race !
                    </button>
                    <button onclick="resetCapture()" class="text-sm text-slate-400 hover:text-slate-600 transition-colors">
                        <i class="fas fa-arrow-rotate-left"></i> Changer de photo
                    </button>
                </div>
            </section>

            <!-- ===== LOADING SECTION ===== -->
            <section id="loading-section" class="hidden text-center py-16">
                <div class="text-5xl mb-6 animate-wiggle">üîç</div>
                <p id="loading-text" class="text-lg font-semibold text-slate-700 mb-4">Analyse de votre museau...</p>
                <div class="w-full max-w-sm mx-auto bg-slate-100 rounded-full h-3 overflow-hidden mb-4">
                    <div id="loading-bar" class="h-full bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
            </section>

            <!-- ===== RESULT SECTION ===== -->
            <section id="result-section" class="hidden">
                <div class="result-card animate-slide-up">
                    
                    <!-- Match header -->
                    <div class="bg-gradient-to-r from-primary-500 to-secondary-500 px-6 py-6 text-center text-white">
                        <p class="text-sm font-medium opacity-80 mb-1">Vous ressemblez √† un...</p>
                        <h2 id="result-breed-name" class="text-3xl sm:text-4xl font-extrabold mb-2"></h2>
                        <div class="match-badge animate-bounce-in" style="animation-delay: 0.3s;">
                            <span id="result-percentage"></span>%
                        </div>
                    </div>

                    <!-- Photo comparison -->
                    <div class="relative grid grid-cols-2 gap-0">
                        <div class="aspect-square overflow-hidden bg-slate-100">
                            <img id="result-user-photo" class="w-full h-full object-cover" alt="Votre photo">
                        </div>
                        <div class="aspect-square overflow-hidden bg-slate-100">
                            <img id="result-breed-photo" class="w-full h-full object-cover" alt="Race de chien">
                        </div>
                        <div class="vs-circle">VS</div>
                    </div>

                    <!-- Details -->
                    <div class="p-6 sm:p-8">
                        <p id="result-reason" class="text-slate-600 text-base leading-relaxed mb-6"></p>

                        <!-- Traits communs -->
                        <div class="mb-6">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Vos traits en commun</h3>
                            <div id="result-traits" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- CTA buttons -->
                        <div class="flex flex-col sm:flex-row gap-3 mb-6">
                            <a id="result-breed-link" href="#" class="flex-1 inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-xl transition-all hover:-translate-y-0.5 shadow-lg shadow-primary-500/25">
                                <i class="fas fa-paw"></i> Voir la fiche compl√®te
                            </a>
                            <button onclick="resetAll()" class="flex-1 inline-flex items-center justify-center gap-2 px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-xl transition-all border border-slate-200">
                                <i class="fas fa-arrow-rotate-left"></i> Refaire le test
                            </button>
                        </div>

                        <!-- Share buttons -->
                        <div>
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Partager mon r√©sultat</h3>
                            <div class="flex flex-wrap gap-2">
                                <a id="share-x" href="#" target="_blank" class="share-btn share-btn-x">
                                    <i class="fab fa-x-twitter"></i> X
                                </a>
                                <a id="share-fb" href="#" target="_blank" class="share-btn share-btn-fb">
                                    <i class="fab fa-facebook-f"></i> Facebook
                                </a>
                                <a id="share-wa" href="#" target="_blank" class="share-btn share-btn-wa">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </a>
                                <button onclick="downloadResult()" class="share-btn share-btn-download">
                                    <i class="fas fa-download"></i> T√©l√©charger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Footer (same as other pages) -->
    <footer class="bg-slate-900 text-slate-400 py-16 mt-12">
        <div class="max-w-[1200px] mx-auto px-6">
            <div class="text-center mb-12">
                <div class="text-4xl mb-3">üêï</div>
                <h3 class="text-white font-bold text-2xl mb-2">Race de Chien</h3>
                <p class="text-slate-400 text-sm max-w-md mx-auto">L'encyclop√©die compl√®te des 169 races canines. Trouvez votre compagnon id√©al gr√¢ce √† nos filtres intelligents.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 mb-12 text-center sm:text-left">
                <div>
                    <h4 class="text-white font-semibold text-sm uppercase tracking-wider mb-4">Navigation</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="/" class="hover:text-white transition-colors">Accueil</a></li>
                        <li><a href="/compare.html" class="hover:text-white transition-colors">Comparer les races</a></li>
                        <li><a href="/tel-maitre-tel-chien.html" class="hover:text-white transition-colors font-medium text-white">Tel Ma√Ætre, Tel Chien</a></li>
                        <li><a href="/sitemap.xml" class="hover:text-white transition-colors">Plan du site</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-semibold text-sm uppercase tracking-wider mb-4">Races populaires</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="/races/berger-allemand.html" class="hover:text-white transition-colors">Berger Allemand</a></li>
                        <li><a href="/races/golden-retriever.html" class="hover:text-white transition-colors">Golden Retriever</a></li>
                        <li><a href="/races/labrador-retriever.html" class="hover:text-white transition-colors">Labrador Retriever</a></li>
                        <li><a href="/races/bouledogue-francais.html" class="hover:text-white transition-colors">Bouledogue Fran√ßais</a></li>
                        <li><a href="/races/berger-australien.html" class="hover:text-white transition-colors">Berger Australien</a></li>
                        <li><a href="/races/husky-siberien.html" class="hover:text-white transition-colors">Husky Sib√©rien</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-semibold text-sm uppercase tracking-wider mb-4">Autres races</h4>
                    <ul class="space-y-3 text-sm">
                        <li><a href="/races/cavalier-king-charles.html" class="hover:text-white transition-colors">Cavalier King Charles</a></li>
                        <li><a href="/races/shiba-inu.html" class="hover:text-white transition-colors">Shiba Inu</a></li>
                        <li><a href="/races/border-collie.html" class="hover:text-white transition-colors">Border Collie</a></li>
                        <li><a href="/races/rottweiler.html" class="hover:text-white transition-colors">Rottweiler</a></li>
                        <li><a href="/races/beagle.html" class="hover:text-white transition-colors">Beagle</a></li>
                        <li><a href="/races/yorkshire-terrier.html" class="hover:text-white transition-colors">Yorkshire Terrier</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-slate-700/50 pt-8 flex flex-col sm:flex-row items-center justify-between gap-4 text-sm">
                <p>¬© 2026 <a href="https://race-de-chien.com" class="hover:text-white transition-colors">Race de Chien</a> ‚Äî Encyclop√©die canine compl√®te</p>
                <p>Cr√©√© par <a href="https://aurorastudio.fr" target="_blank" rel="noopener" class="text-slate-300 hover:text-white transition-colors font-medium">Aurora Studio</a></p>
            </div>
        </div>
    </footer>

    <!-- Canvas for generating share image (hidden) -->
    <canvas id="share-canvas" class="hidden"></canvas>

    <!-- Header script -->
    <script src="/js/header.js"></script>

    <script>
    // ===== CONFIG =====
    const API_URL = '/api/match-breed';

    // ===== STATE =====
    let currentImageBase64 = null;
    let currentImageMimeType = null;
    let webcamStream = null;
    let breedsData = null;
    let breedSlugs = null;
    let currentResult = null;

    // ===== LOADING MESSAGES =====
    const loadingMessages = [
        "Analyse de votre museau...",
        "Comparaison des oreilles...",
        "√âvaluation du regard...",
        "V√©rification de la coiffure...",
        "Consultation de l'encyclop√©die canine...",
        "Recherche de votre race id√©ale...",
        "Calcul du taux de ressemblance...",
    ];

    // ===== INIT: Load breeds data =====
    async function loadBreedsData() {
        try {
            const [breedsRes, slugsRes] = await Promise.all([
                fetch('/data/breeds.json'),
                fetch('/data/breed-slugs.json')
            ]);
            const breedsJson = await breedsRes.json();
            breedsData = breedsJson.breeds;
            breedSlugs = await slugsRes.json();
        } catch (e) {
            console.error('Erreur chargement donn√©es races:', e);
        }
    }
    loadBreedsData();

    // ===== CAPTURE FUNCTIONS =====

    function handleCaptureClick() {
        // Only trigger file upload if no image and no webcam active
        if (!currentImageBase64 && !webcamStream) {
            document.getElementById('file-input').click();
        }
    }

    async function startWebcam() {
        try {
            const video = document.getElementById('webcam-video');
            webcamStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 1280 } } 
            });
            video.srcObject = webcamStream;
            
            // Show webcam, hide placeholder
            video.classList.remove('hidden');
            document.getElementById('capture-placeholder').classList.add('hidden');
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('webcam-controls').classList.remove('hidden');
            document.getElementById('capture-zone').classList.add('active');
        } catch (e) {
            alert('Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions de votre navigateur.');
            console.error(e);
        }
    }

    function captureWebcam() {
        const video = document.getElementById('webcam-video');
        const canvas = document.createElement('canvas');
        
        // Square crop from center
        const size = Math.min(video.videoWidth, video.videoHeight);
        canvas.width = 1024;
        canvas.height = 1024;
        const ctx = canvas.getContext('2d');
        
        // Mirror + crop
        ctx.translate(1024, 0);
        ctx.scale(-1, 1);
        const sx = (video.videoWidth - size) / 2;
        const sy = (video.videoHeight - size) / 2;
        ctx.drawImage(video, sx, sy, size, size, 0, 0, 1024, 1024);
        
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        currentImageBase64 = dataUrl.split(',')[1];
        currentImageMimeType = 'image/jpeg';
        
        showImagePreview(dataUrl);
        stopWebcam();
    }

    function stopWebcam() {
        if (webcamStream) {
            webcamStream.getTracks().forEach(t => t.stop());
            webcamStream = null;
        }
        const video = document.getElementById('webcam-video');
        video.srcObject = null;
        video.classList.add('hidden');
        document.getElementById('webcam-controls').classList.add('hidden');
        document.getElementById('capture-zone').classList.remove('active');
        
        if (!currentImageBase64) {
            document.getElementById('capture-placeholder').classList.remove('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
        }
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            currentImageMimeType = file.type || 'image/jpeg';
            
            // Resize if needed
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxSize = 1024;
                let w = img.width, h = img.height;
                if (w > maxSize || h > maxSize) {
                    if (w > h) { h = (h / w) * maxSize; w = maxSize; }
                    else { w = (w / h) * maxSize; h = maxSize; }
                }
                canvas.width = w;
                canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                const resized = canvas.toDataURL('image/jpeg', 0.85);
                currentImageBase64 = resized.split(',')[1];
                currentImageMimeType = 'image/jpeg';
                showImagePreview(resized);
            };
            img.src = dataUrl;
        };
        reader.readAsDataURL(file);
        event.target.value = ''; // reset
    }

    function showImagePreview(dataUrl) {
        const preview = document.getElementById('image-preview');
        preview.src = dataUrl;
        preview.classList.remove('hidden');
        document.getElementById('capture-placeholder').classList.add('hidden');
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('analyze-controls').classList.remove('hidden');
        document.getElementById('capture-zone').classList.add('has-image');
        document.getElementById('capture-zone').onclick = null;
    }

    function resetCapture() {
        currentImageBase64 = null;
        currentImageMimeType = null;
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('image-preview').src = '';
        document.getElementById('capture-placeholder').classList.remove('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
        document.getElementById('analyze-controls').classList.add('hidden');
        document.getElementById('capture-zone').classList.remove('has-image');
        document.getElementById('capture-zone').onclick = () => handleCaptureClick();
    }

    // ===== ANALYSIS =====

    async function analyzePhoto() {
        if (!currentImageBase64) return;
        
        // Show loading
        document.getElementById('capture-section').classList.add('hidden');
        document.getElementById('hero-section').classList.add('hidden');
        document.getElementById('loading-section').classList.remove('hidden');
        
        // Animate loading
        animateLoading();
        
        try {
            // Build slug list from data
            const slugList = breedSlugs ? Object.values(breedSlugs).join(', ') : '';
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_base64: currentImageBase64,
                    mime_type: currentImageMimeType,
                    slug_list: slugList
                })
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error?.message || `API error ${response.status}`);
            }

            const data = await response.json();
            const text = data.content[0].text.trim();
            
            // Parse JSON (handle potential markdown wrapping)
            let result;
            try {
                const cleaned = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                result = JSON.parse(cleaned);
            } catch (parseErr) {
                console.error('JSON parse error:', text);
                throw new Error('R√©ponse inattendue de l\'IA');
            }
            
            currentResult = result;
            showResult(result);
            
        } catch (error) {
            console.error('Erreur analyse:', error);
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('hero-section').classList.remove('hidden');
            document.getElementById('capture-section').classList.remove('hidden');
            alert('Oups ! Une erreur est survenue lors de l\'analyse. ' + error.message + '\n\nVeuillez r√©essayer.');
        }
    }

    function animateLoading() {
        let step = 0;
        const bar = document.getElementById('loading-bar');
        const text = document.getElementById('loading-text');
        
        const interval = setInterval(() => {
            step++;
            if (step >= loadingMessages.length) {
                clearInterval(interval);
                bar.style.width = '95%';
                return;
            }
            text.textContent = loadingMessages[step];
            bar.style.width = `${Math.min(15 + step * 13, 95)}%`;
        }, 700);
        
        // Store interval to clear later
        window._loadingInterval = interval;
    }

    // ===== DISPLAY RESULT =====

    function showResult(result) {
        if (window._loadingInterval) clearInterval(window._loadingInterval);
        
        // Find breed data
        const breed = breedsData?.find(b => {
            const id = b.id;
            return breedSlugs && breedSlugs[id] === result.breed_slug;
        });
        
        // Fill in result data
        const breedName = breed?.name_fr || result.breed_slug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        document.getElementById('result-breed-name').textContent = breedName;
        document.getElementById('result-percentage').textContent = result.match_percentage;
        document.getElementById('result-reason').textContent = result.reason;
        
        // User photo
        document.getElementById('result-user-photo').src = `data:${currentImageMimeType};base64,${currentImageBase64}`;
        
        // Breed photo
        const breedImgId = breed?.id || '115';
        document.getElementById('result-breed-photo').src = `/images/breeds/${breedImgId}.jpg`;
        document.getElementById('result-breed-photo').onerror = function() {
            // Fallback to URL from breeds data
            if (breed?.images?.url) this.src = breed.images.url;
        };
        
        // Breed link
        document.getElementById('result-breed-link').href = `/races/${result.breed_slug}.html`;
        
        // Traits
        const traitsContainer = document.getElementById('result-traits');
        traitsContainer.innerHTML = result.traits_communs.map(t => 
            `<span class="trait-badge">${t}</span>`
        ).join('');
        
        // Share links
        const shareText = `Je ressemble √† un ${breedName} √† ${result.match_percentage}% ! üêï D√©couvrez √† quelle race de chien vous ressemblez :`;
        const shareUrl = 'https://race-de-chien.com/tel-maitre-tel-chien.html';
        
        document.getElementById('share-x').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
        document.getElementById('share-fb').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`;
        document.getElementById('share-wa').href = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`;
        
        // Show result, hide loading
        document.getElementById('loading-section').classList.add('hidden');
        document.getElementById('result-section').classList.remove('hidden');
        
        // Confetti!
        launchConfetti();
        
        // Scroll to result
        document.getElementById('result-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ===== RESET =====

    function resetAll() {
        currentResult = null;
        document.getElementById('result-section').classList.add('hidden');
        document.getElementById('hero-section').classList.remove('hidden');
        document.getElementById('capture-section').classList.remove('hidden');
        resetCapture();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== CONFETTI =====

    function launchConfetti() {
        const colors = ['#3b82f6', '#9333ea', '#f97316', '#10b981', '#f43f5e', '#eab308'];
        const shapes = ['‚óè', '‚ñ†', '‚ñ≤', 'üêæ'];
        
        for (let i = 0; i < 40; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.textContent = shapes[Math.floor(Math.random() * shapes.length)];
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.color = colors[Math.floor(Math.random() * colors.length)];
            piece.style.fontSize = (Math.random() * 12 + 8) + 'px';
            piece.style.animationDuration = (Math.random() * 2 + 2) + 's';
            piece.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(piece);
            
            setTimeout(() => piece.remove(), 4000);
        }
    }

    // ===== DOWNLOAD RESULT IMAGE =====

    async function downloadResult() {
        if (!currentResult) return;
        
        const canvas = document.getElementById('share-canvas');
        canvas.width = 1080;
        canvas.height = 1080;
        const ctx = canvas.getContext('2d');
        
        // Background
        const gradient = ctx.createLinearGradient(0, 0, 1080, 1080);
        gradient.addColorStop(0, '#3b82f6');
        gradient.addColorStop(1, '#9333ea');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1080, 1080);
        
        // White card
        ctx.fillStyle = 'white';
        roundRect(ctx, 40, 40, 1000, 1000, 30);
        ctx.fill();
        
        // Title
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 42px Plus Jakarta Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Tel Ma√Ætre, Tel Chien üêï', 540, 110);
        
        // Load and draw images
        try {
            const userImg = await loadImage(`data:${currentImageMimeType};base64,${currentImageBase64}`);
            const breedId = breedsData?.find(b => breedSlugs?.[b.id] === currentResult.breed_slug)?.id || '115';
            
            // User photo (left)
            ctx.save();
            roundRect(ctx, 80, 150, 420, 420, 20);
            ctx.clip();
            drawCover(ctx, userImg, 80, 150, 420, 420);
            ctx.restore();
            
            // Breed photo (right)
            try {
                const breedImg = await loadImage(`/images/breeds/${breedId}.jpg`);
                ctx.save();
                roundRect(ctx, 580, 150, 420, 420, 20);
                ctx.clip();
                drawCover(ctx, breedImg, 580, 150, 420, 420);
                ctx.restore();
            } catch(e) {
                ctx.fillStyle = '#f1f5f9';
                roundRect(ctx, 580, 150, 420, 420, 20);
                ctx.fill();
            }
        } catch(e) {
            console.error('Image load error for share canvas:', e);
        }
        
        // VS badge
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(540, 360, 35, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 22px Plus Jakarta Sans, sans-serif';
        ctx.fillText('VS', 540, 368);
        
        // Breed name
        const breedName = document.getElementById('result-breed-name').textContent;
        ctx.fillStyle = '#1e293b';
        ctx.font = 'bold 38px Plus Jakarta Sans, sans-serif';
        ctx.fillText(breedName, 540, 640);
        
        // Percentage
        const pct = currentResult.match_percentage;
        ctx.fillStyle = '#3b82f6';
        ctx.font = 'bold 56px Plus Jakarta Sans, sans-serif';
        ctx.fillText(`${pct}%`, 540, 710);
        
        // Reason (wrapped)
        ctx.fillStyle = '#64748b';
        ctx.font = '20px Plus Jakarta Sans, sans-serif';
        wrapText(ctx, currentResult.reason, 540, 770, 880, 28);
        
        // Footer
        ctx.fillStyle = '#94a3b8';
        ctx.font = '18px Plus Jakarta Sans, sans-serif';
        ctx.fillText('race-de-chien.com/tel-maitre-tel-chien', 540, 1010);
        
        // Download
        const link = document.createElement('a');
        link.download = `tel-maitre-tel-chien-${currentResult.breed_slug}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    // Canvas helper functions
    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
    }

    function drawCover(ctx, img, x, y, w, h) {
        const ratio = Math.max(w / img.width, h / img.height);
        const nw = img.width * ratio;
        const nh = img.height * ratio;
        ctx.drawImage(img, x + (w - nw) / 2, y + (h - nh) / 2, nw, nh);
    }

    function loadImage(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        let lineCount = 0;
        for (const word of words) {
            const test = line + word + ' ';
            if (ctx.measureText(test).width > maxWidth && line) {
                ctx.fillText(line.trim(), x, y + lineCount * lineHeight);
                line = word + ' ';
                lineCount++;
                if (lineCount >= 4) { // Max 4 lines
                    ctx.fillText(line.trim() + '...', x, y + lineCount * lineHeight);
                    return;
                }
            } else {
                line = test;
            }
        }
        ctx.fillText(line.trim(), x, y + lineCount * lineHeight);
    }
    </script>
</body>
</html>
